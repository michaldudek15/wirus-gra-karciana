{% extends 'base.html' %}

{% block body %}

<div class="gorny-pasek">
    <h1>gra hotseat</h1>
    <p>
        <a href="{{ url_for('index') }}" class="przycisk">powrót do strony głównej</a>
    </p>
</div>

<div class="panel-kart {% if player2.playerId != activePlayer.playerId %}ukryta{% endif %}" id="panel-kart-bot" data-playerid="{{ player2.playerId }}">
    {% for card in player2.hand %}
    <div class="karta-reka"
        id="{{ card.cardId }}"
         style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};"
         onclick="wybor(this)">
         <h3>{{ card.name }}</h3>
        <!-- <p>id: {{ card.cardId }}</p> -->
    </div>
    {% endfor %}
</div>

<div class="panel-ciala" id="panel-ciala-bot" data-playerid="{{ player2.playerId}}">
    {% set sloty = 5 %}
    {% set liczbaKartWCiele = player2.organsOnTable|length %}

    {% for card in player2.organsOnTable %}
    <div class="karta-cialo"
        id="{{ card.cardId }}"
         style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};"
         onclick="wyborTargetu(this)">
         <h3>{{ card.name }}</h3>
         <p>status: {{ card.status }}</p>
         <!-- <p>id: {{ card.cardId }}</p> -->
    </div>
    {% endfor %}

    {# Puste miejsca – unikalny id generowany z indeksem #}
    {% for i in range(sloty - liczbaKartWCiele) %}
    <div class="karta-placeholder" id="placeholder"
         onclick="wyborTargetu(this)">
         <h3>puste</h3>
    </div>
    {% endfor %}
</div>

<div class="przycisk-container">
    <button onclick="anulujWybor()" class="przycisk" id="przycisk-anuluj">Anuluj wybór</button>
</div>

<div class="przycisk-container" >
    <form method="POST" action="{{ url_for('zagrajKarte') }}" id="zagrajKarteForm">
        <input type="hidden" id="source_player_id" name="source_player_id" value="">
        <input type="hidden" id="source_card_id" name="source_card_id" value="">
        <input type="hidden" id="target_player_id" name="target_player_id" value="">
        <input type="hidden" id="target_card_id" name="target_card_id" value="">
        <button type="submit" class="przycisk" id="przycisk-akceptuj">Akceptuj ruch</button>
    </form>
</div>

<div class="przycisk-container" id="przyciski-wymiana">
    <form method="POST" action="{{ url_for('wymienKarty') }}">
      <!-- Przekazujemy id gracza (źródłowego) ukrytym polem -->
      <input type="hidden" name="source_player_id" value="">
      
      <!-- Pola do wpisania identyfikatorów kart, które gracz chce wymienić.
           Jeśli gracz wymienia mniej niż 3 karty, pozostaw puste pola -->
      <input type="hidden" name="first_card_id" value="">
      <input type="hidden" name="second_card_id" value="">
      <input type="hidden" name="third_card_id" value="">
      <button class="przycisk" id="przycisk-wymiana">wymień karty</button>
      <button type="submit" class="przycisk" id="przycisk-akceptuj-wymiana">akceptuj wymianę</button>
    </form>
  </div>

<div class="panel-ciala" id="panel-ciala-gracz" data-playerid="{{ player1.playerId}}">
    {% set sloty = 5 %}
    {% set liczbaKartWCiele = player1.organsOnTable|length %}

    {% for card in player1.organsOnTable %}
    <div class="karta-cialo"
        id="{{ card.cardId }}"
         style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};"
         onclick="wyborTargetu(this)">
         <h3>{{ card.name }}</h3>
         <p>status: {{ card.status }}</p>
         <!-- <p>id: {{ card.cardId }}</p> -->
    </div>
    {% endfor %}

    {# Puste miejsca – unikalny id generowany z indeksem #}
    {% for i in range(sloty - liczbaKartWCiele) %}
    <div class="karta-placeholder" id="placeholder"
         onclick="wyborTargetu(this)">
         <h3>puste</h3>
    </div>
    {% endfor %}
</div>

<div class="panel-kart {% if player1.playerId != activePlayer.playerId %}ukryta{% endif %}" id="panel-kart-gracz" data-playerid="{{ player1.playerId }}">
    {% for card in player1.hand %}
    <div class="karta-reka"
        id="{{ card.cardId }}"
         style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};"
         onclick="wybor(this)">
        <h3>{{ card.name }}</h3>
        <!-- <p>{{ card.cardId }}</p> -->
    </div>
    {% endfor %}
</div>

<script>
    function wybor(elem) {
        // Pobierz kontener, w którym znajduje się karta (np. panel-kart-gracz lub panel-kart-bot)
        var container = elem.closest('.panel-kart');
        var playerId = container ? container.getAttribute('data-playerid') : "";
        console.log("Wybrano kartę źródłową o id: " + elem.id + " gracza o id: " + playerId);

        // Jeśli kliknięta karta jest już zaznaczona, usuń podświetlenie i wyczyść ukryte pola formularza
        if (elem.classList.contains('highlight')) {
            elem.classList.remove('highlight');
            var sourceCardInput = document.getElementById('source_card_id');
            if (sourceCardInput) {
                sourceCardInput.value = "";
            }
            var sourcePlayerInput = document.getElementById('source_player_id');
            if (sourcePlayerInput) {
                sourcePlayerInput.value = "";
            }
            return;
        }

        // Usuń podświetlenie ze wszystkich kart we wszystkich panelach rąk
        var cards = document.querySelectorAll('.panel-kart .karta-reka');
        cards.forEach(function(card) {
            card.classList.remove('highlight');
        });

        // Podświetl klikniętą kartę
        elem.classList.add('highlight');

        // Uzupełnij wartości w formularzu:
        // - id źródłowej karty
        // - id źródłowego gracza
        var sourceCardInput = document.getElementById('source_card_id');
        if (sourceCardInput) {
            sourceCardInput.value = elem.id;
        }
        var sourcePlayerInput = document.getElementById('source_player_id');
        if (sourcePlayerInput) {
            sourcePlayerInput.value = playerId;
        }
    }

    function wyborTargetu(elem) {
        // Pobierz najbliższy kontener panelu ciała, żeby odczytać atrybut data-playerid
        var container = elem.closest('.panel-ciala');
        var playerId = container ? container.getAttribute('data-playerid') : "";

        console.log("Wybrano kartę o id: " + elem.id + " gracza o id: " + playerId);


        // Jeśli kliknięty element jest już podświetlony, to usuń podświetlenie oraz wyczyść ukryte pola
        if (elem.classList.contains('highlight')) {
            elem.classList.remove('highlight');

            var targetCardInput = document.getElementById('target_card_id');
            if (targetCardInput) {
                targetCardInput.value = "";
            }
            var targetPlayerInput = document.getElementById('target_player_id');
            if (targetPlayerInput) {
                targetPlayerInput.value = "";
            }
            return;
        }

        // Usuń podświetlenie ze wszystkich elementów docelowych (we wszystkich panelach ciała)
        var targets = document.querySelectorAll('.panel-ciala .karta-cialo, .panel-ciala .karta-placeholder');
        targets.forEach(function(target) {
            target.classList.remove('highlight');
        });

        // Podświetl kliknięty element
        elem.classList.add('highlight');

        // Ustaw wartość ukrytego pola target_card_id:
        // Jeśli kliknięty element to placeholder, nie ustawiamy id karty (pozostawiamy placeholder)
        // Jeśli to karta – ustawiamy jej id
        var targetCardInput = document.getElementById('target_card_id');
        if (targetCardInput) {
            if (elem.classList.contains('karta-placeholder')) {
                targetCardInput.value = "placeholder";
            } else {
                targetCardInput.value = elem.id;
            }
        }

        // Ustaw wartość ukrytego pola target_player_id na id gracza pobrane z kontenera
        var targetPlayerInput = document.getElementById('target_player_id');
        if (targetPlayerInput) {
            targetPlayerInput.value = playerId;
        }
    }

    function anulujWybor() {
        // Usuń podświetlenia ze wszystkich elementów
        var highlightedElements = document.querySelectorAll('.highlight');
        highlightedElements.forEach(function(element) {
            element.classList.remove('highlight');
        });

        // Wyczyść wartości w formularzu
        var sourcePlayerInput = document.getElementById('source_player_id');
        var sourceCardInput = document.getElementById('source_card_id');
        var targetPlayerInput = document.getElementById('target_player_id');
        var targetCardInput = document.getElementById('target_card_id');
        
        if (sourcePlayerInput) { sourcePlayerInput.value = ""; }
        if (sourceCardInput) { sourceCardInput.value = ""; }
        if (targetPlayerInput) { targetPlayerInput.value = ""; }
        if (targetCardInput) { targetCardInput.value = ""; }

        console.log("Anulowano wybór, wszystkie podświetlenia i wartości formularza zostały usunięte.");
    }

    var komunikat = "{{ komunikat }}";
    if(komunikat != "") {
        alert(komunikat);
    }

    document.getElementById('zagrajKarteForm').addEventListener('submit', function(event) {
        // Zatrzymujemy wysyłkę formularza, aby pokazać alert
        event.preventDefault();
        
        // Pobierz wartości z ukrytych pól
        var sourcePlayer = document.getElementById('source_player_id').value.trim();
        var source = document.getElementById('source_card_id').value.trim();
        var targetPlayer = document.getElementById('target_player_id').value.trim();
        var target = document.getElementById('target_card_id').value.trim();


        // Sprawdź, czy oba pola są wypełnione
        if (source === "" || target === "") {
            alert("Błąd: Nie wybrano karty źródłowej lub targetu!");
        } else {
            // alert("szczegóły ruchu: \ngracz źródłowy: " + sourcePlayer + "\nKarta źródłowa: " + source + "\nkarta targetowana: " + target + "\ngracz targetowany: " + targetPlayer);
            event.target.submit();
        }
    });

</script>


<!-- <script>
    
    sprawdzenie wartości w formularzu


    
</script> -->
{% endblock %}
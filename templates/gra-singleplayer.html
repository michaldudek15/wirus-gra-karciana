{% extends 'base.html' %}

{% block body %}

<div id="cancel-button-container">
    <button onclick="anulujWybor()" class="cancel-button">Anuluj wybór</button>
</div>

<div id="accept-button-container">

    <form method="POST" action="zagrajKarte" id="zagrajKarteForm">
        <input type="hidden" id="source_player_id" name="source_player_id" value="{{ player1.id }}">
        <input type="hidden" id="source_card_id" name="source_card_id" value="{{ source_card_id }}">
        <input type="hidden" id="target_card_id" name="target_card_id" value="{{ target_card_id }}">

        <button type="submit" class="accept-button">Akceptuj ruch</button>
    </form>
</div>


<div class="gorny-pasek">
    <h1>gra singleplayer</h1>
    <p class="powrot">
        <a href="{{ url_for('index') }}" class="button">powrót do strony głównej</a>
    </p>
</div>

<div class="panel-kart-bot">
    {% for card in player2.hand %}
    <form method="POST" action="/playcard" class="card-form">
        <button class="card"
                type="submit"
                name="card_name"
                value="{{ card_name }}"
                style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};">
            <h3>{{ card.name }}</h3>
            <p>id: {{ card.id }}</p>
        </button>
    </form>
    {% endfor %}
</div>

<div class="panel-ciala-bot">
    {% for card in player2.organsOnTable %}
    <div class="card"
         style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};">
        <h3>{{ card.name }}</h3>
        <p>status: {{ card.status }}</p>
        <p>id: {{ card.id }}</p>
    </div>
    {% endfor %}
</div>

<div class="panel-ciala-gracz">
    {% set sloty = 5 %}
    {% set liczbaKartWCiele = player1.organsOnTable|length %}

    {# Karty w ciele gracza – kliknięcie ustawia target #}
    {% for card in player1.organsOnTable %}
    <div class="card target" id="card_{{ card.id }}"
         style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};"
         onclick="wyborTargetu(this)">
         <h3>{{ card.name }}</h3>
         <p>status: {{ card.status }}</p>
         <p>id: {{ card.id }}</p>
    </div>
    {% endfor %}

    {# Puste miejsca – unikalny id generowany z indeksem #}
    {% for i in range(sloty - liczbaKartWCiele) %}
    <div class="card-placeholder target" id="card_000_{{ i }}"
         onclick="wyborTargetu(this)">
         <h3>puste</h3>
    </div>
    {% endfor %}
</div>

<div class="panel-kart-gracz">
    {% for card in player1.hand %}
    <div class="card" id="card_{{ card.id }}"
         style="background: {% if card.color == 'joker' %}linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet){% else %}{{ card.color }}{% endif %};"
         onclick="wybor('{{ card.id }}')">
        <h3>{{ card.name }}</h3>
        <p>{{ card.id }}</p>
    </div>
    {% endfor %}
</div>

<script>
    function wybor(cardId) {
        console.log("wybrano kartę o id: " + cardId);
    
        // Usuń podświetlenie ze wszystkich kart w ręce
        var cards = document.querySelectorAll('.panel-kart-gracz .card');
        cards.forEach(function(card) {
            card.classList.remove('highlight');
        });
        
        // Dodaj podświetlenie do wybranej karty
        var selectedCard = document.getElementById("card_" + cardId);
        if (selectedCard) {
            selectedCard.classList.add('highlight');
        }
        
        // Ustaw wartość ukrytego pola formularza source_card_id na cardId
        var sourceInput = document.getElementById('source_card_id');
        if (sourceInput) {
            sourceInput.value = cardId;
        }
    }
    
    function wyborTargetu(elem) {
        console.log("wybrano target:", elem.id);
        var targets = document.querySelectorAll('.panel-ciala-gracz .target');
        targets.forEach(function(target) {
            target.classList.remove('highlight');
        });
        elem.classList.add('highlight');
    
        // Jeśli chcesz przekazać cały id elementu:
        // var targetId = elem.id;
        // Jeśli chcesz usunąć prefiks "card_", aby uzyskać tylko numer lub unikalny identyfikator:
        var targetId = elem.id.replace("card_", "");
    
        var targetInput = document.getElementById('target_card_id');
        if (targetInput) {
            targetInput.value = targetId;
        }
    }
    
    function anulujWybor() {
        console.log("Anulowano wybór");
        
        // Usuń podświetlenie z kart w ręce
        var handCards = document.querySelectorAll('.panel-kart-gracz .card.highlight');
        handCards.forEach(function(card) {
            card.classList.remove('highlight');
        });
        
        // Usuń podświetlenie z targetów (kart i pustych miejsc w ciele)
        var targets = document.querySelectorAll('.panel-ciala-gracz .target.highlight');
        targets.forEach(function(target) {
            target.classList.remove('highlight');
        });

         // Wyczyszczenie wartości ukrytych pól formularza
        var sourceInput = document.getElementById('source_card_id');
        if (sourceInput) {
            sourceInput.value = "";
        }
        var targetInput = document.getElementById('target_card_id');
        if (targetInput) {
            targetInput.value = "";
        }
    }
</script>


<script>
    document.getElementById('zagrajKarteForm').addEventListener('submit', function(event) {
        // Zatrzymujemy wysyłkę formularza, aby pokazać alert
        event.preventDefault();
        
        // Pobierz wartości z ukrytych pól
        var source = document.getElementById('source_card_id').value.trim();
        var target = document.getElementById('target_card_id').value.trim();
        var sourcePlayer = document.getElementById('source_player_id').value.trim();


        // Sprawdź, czy oba pola są wypełnione
        if (source === "" || target === "") {
            alert("Błąd: Nie wybrano karty źródłowej lub targetu!");
        } else {
            alert("Zagrano karty: \nKarta źródłowa: " + source + "\nTarget: " + target + "\ngracz: " + sourcePlayer);
        }
    });
</script>
{% endblock %}